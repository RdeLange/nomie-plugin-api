"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LSAndTSDocResolver = void 0;
const typescript_1 = __importDefault(require("typescript"));
const utils_1 = require("../../utils");
const DocumentSnapshot_1 = require("./DocumentSnapshot");
const service_1 = require("./service");
class LSAndTSDocResolver {
    constructor(docManager, workspaceUris, configManager, transformOnTemplateError = true) {
        this.docManager = docManager;
        this.workspaceUris = workspaceUris;
        this.configManager = configManager;
        this.transformOnTemplateError = transformOnTemplateError;
        /**
         * Create a svelte document -> should only be invoked with svelte files.
         */
        this.createDocument = (fileName, content) => {
            const uri = utils_1.pathToUrl(fileName);
            const document = this.docManager.openDocument({
                text: content,
                uri
            });
            this.docManager.lockDocument(uri);
            return document;
        };
        docManager.on('documentChange', utils_1.debounceSameArg(async (document) => {
            // This refreshes the document in the ts language service
            this.getLSAndTSDoc(document);
        }, (newDoc, prevDoc) => newDoc.uri === (prevDoc === null || prevDoc === void 0 ? void 0 : prevDoc.uri), 1000));
    }
    get lsDocumentContext() {
        return {
            createDocument: this.createDocument,
            transformOnTemplateError: this.transformOnTemplateError
        };
    }
    getLSForPath(path) {
        return service_1.getLanguageServiceForPath(path, this.workspaceUris, this.lsDocumentContext);
    }
    getLSAndTSDoc(document) {
        const lang = service_1.getLanguageServiceForDocument(document, this.workspaceUris, this.lsDocumentContext);
        const filePath = document.getFilePath();
        const tsDoc = this.getSnapshot(filePath, document);
        const userPreferences = this.getUserPreferences(tsDoc.scriptKind);
        return { tsDoc, lang, userPreferences };
    }
    getSnapshot(filePath, document) {
        const tsService = this.getTSService(filePath);
        const { snapshotManager } = tsService;
        let tsDoc = snapshotManager.get(filePath);
        if (!tsDoc) {
            const options = {
                strictMode: !!tsService.compilerOptions.strict,
                transformOnTemplateError: this.transformOnTemplateError
            };
            tsDoc = document
                ? DocumentSnapshot_1.DocumentSnapshot.fromDocument(document, options)
                : DocumentSnapshot_1.DocumentSnapshot.fromFilePath(filePath, options);
            snapshotManager.set(filePath, tsDoc);
        }
        return tsDoc;
    }
    updateSnapshotPath(oldPath, newPath) {
        this.deleteSnapshot(oldPath);
        return this.getSnapshot(newPath);
    }
    deleteSnapshot(filePath) {
        this.getTSService(filePath).deleteDocument(filePath);
        this.docManager.releaseDocument(utils_1.pathToUrl(filePath));
    }
    getSnapshotManager(filePath) {
        return this.getTSService(filePath).snapshotManager;
    }
    getTSService(filePath) {
        return service_1.getService(filePath, this.workspaceUris, this.lsDocumentContext);
    }
    getUserPreferences(scriptKind) {
        const configLang = scriptKind === typescript_1.default.ScriptKind.TS || scriptKind === typescript_1.default.ScriptKind.TSX
            ? 'typescript'
            : 'javascript';
        return this.configManager.getTsUserPreferences(configLang);
    }
}
exports.LSAndTSDocResolver = LSAndTSDocResolver;
//# sourceMappingURL=LSAndTSDocResolver.js.map